document.addEventListener("DOMContentLoaded",function(){let imageFields=document.querySelectorAll('[input-image="container"]');if(imageFields){imageFields.forEach(function(b){let enable=true;let form=b.closest("form"),idField=form.querySelector('input[name*="'+b.getAttribute("data-pk")+'"'),available=b.querySelector('[input-image="available"]'),upload=b.querySelector('[input-image="upload"]'),field=b.querySelector('[input-image="field"]'),image=b.querySelector('[input-image="preview"]'),error=b.querySelector('[input-image="error"]'),deleteButton=b.querySelector('[input-image="delete"]'),viewButton=b.querySelector('[input-image="view"]');image.setAttribute("data-noimage",image.getAttribute("src"));let controller=b.getAttribute("data-controller"),section=b.getAttribute("data-section"),filename=b.getAttribute("data-filename"),pk=(idField)?idField.value*1:0,language=b.getAttribute("data-language"),loading=image.getAttribute("data-loading"),noimage=image.getAttribute("data-noimage");if(pk===0){available.style.display="";enable=false}if(section===""||filename===""||language===""||controller===""){enable=false}if(enable){upload.style.display="";f();deleteButton.addEventListener("click",function(i){g(i);d()});viewButton.addEventListener("click",function(i){g(i);e()});upload.addEventListener("dragenter",g,false);upload.addEventListener("dragover",g,false);upload.addEventListener("dragleave",g,false);upload.addEventListener("drop",g,false);upload.addEventListener("dragenter",h,false);upload.addEventListener("dragover",h,false);upload.addEventListener("dragleave",a,false);upload.addEventListener("drop",a,false);upload.addEventListener("drop",function(i){c(i.dataTransfer.files)});field.addEventListener("change",function(i){g(i);c(i.target.files)})}function g(i){i.preventDefault();i.stopPropagation()}function h(){upload.classList.add("dragend")}function a(){upload.classList.remove("dragend")}function f(){image.setAttribute("src",loading);error.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.loadImage");formData.set("section",section);formData.set("pk",pk);formData.set("filename",filename);formData.set("language",language);request.open("POST",requestUrl);request.send(new URLSearchParams(formData));request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(i){response=false;image.setAttribute("src",noimage);error.innerText=i.message;error.style.display="";return}if(response.success){image.setAttribute("src",(response.data)?response.data:noimage)}else{image.setAttribute("src",noimage);error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){image.setAttribute("src",noimage);error.innerText=request.status+" "+request.statusText;error.style.display=""}}}}function d(){let current=image.getAttribute("src");image.setAttribute("src",loading);error.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.deleteImage");formData.set("section",section);formData.set("pk",pk);formData.set("filename",filename);formData.set("language",language);request.open("POST",requestUrl);request.send(new URLSearchParams(formData));request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(i){response=false;image.setAttribute("src",current);error.innerText=i.message;error.style.display="";return}if(response.success){image.setAttribute("src",(response.data)?noimage:current)}else{image.setAttribute("src",current);error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){image.setAttribute("src",current);error.innerText=request.status+" "+request.statusText;error.style.display=""}}}}function c(i){let current=image.getAttribute("src");image.setAttribute("src",loading);error.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.uploadImage");formData.set("section",section);formData.set("pk",pk);formData.set("filename",filename);formData.set("language",language);Array.from(i).forEach(function(j){formData.append("images[]",j)});request.open("POST",requestUrl);request.send(formData);request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(j){response=false;image.setAttribute("src",current);error.innerText=j.message;error.style.display="";return}if(response.success){image.setAttribute("src",(response.data)?response.data:current)}else{image.setAttribute("src",current);error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){image.setAttribute("src",current);error.innerText=request.status+" "+request.statusText;error.style.display=""}}}}function e(){openPopup(image.getAttribute("src"),"")}})}});